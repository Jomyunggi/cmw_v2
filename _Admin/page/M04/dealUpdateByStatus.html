<script type="text/javascript" src="<?php	echo JS_DIR;	?>/adm_common.js"></script>
<script>
	$(document).ready(function(){
		
	});

	//input text에서 작성후 엔터키를 누르면 페이지가 다른데로 나가는걸 방지하고 검색을 할 수 있도록
	document.addEventListener('keydown', function(event) {
	  if (event.keyCode === 13) {
		searching();
		event.preventDefault();
	  };
	}, true);

	function searching(){
		var frm = document.search_frm;
		frm.submit();
	}

	function updateBydstatus(){ 
		var ajax_url = "/page/ajax/M04/ajax.updateBydstatus.php";
		var idx = $("input:checkbox[name='idx']:checked").val();
		var dstatus = $('#dstatus_'+idx+' option:selected').val();
		var ajax_data = {
			'dealIdx'		: idx,
			'dstatus'		: dstatus,
			'deliveryNum'	: $('#deliveryNum_'+idx).val(),
			'priceKinds'	: $('#priceKinds_'+idx).val(),
			'date'			: $('#date_'+idx).val(),
			'dstart'		: $('#dstart_'+idx).val(),
			'dend'			: $('#dend_'+idx).val()
		};

		//교환일 경우 상품수를 확인해줘야한다.
		var returnNum = Number($('#deliveryNum').val());
		var ifYN = false;
		if(dstatus == 11 || dstatus == 14 || dstatus == 19){
			if(returnNum)	ifYN = true;
		} else {
			ifYN = true;
		}
		if(confirm('상태변경하시겠습니까?')){
			if(ifYN){
				$.ajax({
					url : ajax_url,
					data : ajax_data,
					type : 'POST',
					dataType : 'html',
					contentType: 'application/x-www-form-urlencoded; charset=utf-8',
					success: function (response) {
						if(response == "1"){
							alert('재판매시작합니다');
						} else if(response == "9"){
							alert('삭제되었습니다');
						}  else if(response == "11"){
							alert('교환되었습니다');
						}  else if(response == "14"){
							alert('반품되었습니다');
						}  else if(response == "19"){
							alert('취소되었습니다');
						}  else if(response == "99"){
							alert('환불되었습니다');
						} else if(response == "0"){
							alert('수정되었습니다');
						} else {
							alert('교환/반품/취소 개수를 확인하시기 바랍니다.');
						}
							
						location.href = "/?M0408&searchUser="+$('#searchUser').val()+"&searchUserName="+$('#searchUserName').val();
					},
					failure: function(msg) {
					}
				});
			} else {
				alert('교환/반품 개수를 입력해주세요.');
			}
		}
	}

	function goBack(){
		window.location.href="/?M0401S";
	}
</script>
<div class="container">
	<div class="contents-wrapper">
		<h2 class="page-header">상품 교환/반품/환불/취소 처리</h2>
	</div>

	<!--/* 회원리스트  -->
	<div class="contents-wrapper">
		<div class="panel panel-default">
			<div class="panel-heading text-center">
				<?php 
					echo $M_HTML->b_Form("search_frm", "", "get", 0);
					echo $M_HTML->input_Hidden($MENU_ID.$P_ACTION, "");
				?>
				<div class="form-inline">
					<div class="form-group" style="float:left;">
						<button class="btn btn-sm btn-danger" onclick="javascript:goBack(); return false;">달력보기</button>		
					</div>

					<div class="form-group input-group">
						<?php	
							echo $M_HTML->_Select2("searchUser", $this->searchUser, $searchUser, "form-control", "", "style='width:25%;'");	
							echo $M_HTML->_Select2("searchYear", $this->searchYear, $searchYear, "form-control", "", "style='width:30%;'");
							echo $M_HTML->input_Text2("searchUserName", $searchUserName, "form-control", "width:45%;");
						?>
						<span class="input-group-btn">
							<button class="btn btn-default" type="button" onclick="javascript:searching();"><i class="fa fa-search"></i> 검색</button>
						</span>
					</div>
				</div>
				<?php
					echo $M_HTML->e_Form();
				?>
			</div>
			<table class="table table-bordered table-hover" >
				<colgroup>
					<col width="2%">	<!--체크박스#-->
					<col width="5%">	<!--상태처리-->
					<col width="3%">	<!--반품/취소/교환개수-->
					<col width="7%">	<!--결제,주문일-->
					<col width="5%">	<!--출고일-->
					<col width="5.5%">	<!--발송처리일-->
					<col width="5.5%">	<!--배송완료일-->
					<col width="4%">	<!--배송상태-->
					<col width="6%">	<!--사이트명-->
					<col width="4%">	<!--구매자-->
					<col width="4%">	<!--수하인-->
					<col width="6%">	<!--핸드폰-->
					<col width="11%">	<!--상품명-->
					<col width="17%">	<!--주소-->
					<col width="6%">	<!--priceKinds-->
					<col width="3%">	<!--소-->
					<col width="3%">	<!--중-->
					<col width="3%">	<!--대-->
				</colgroup>
				<thead style="font-size:10.5px; padding:3px;">
					<tr>
						<th style="padding:4px;">#</th>
						<th style="padding:4px;">상태처리</th>
						<th style="padding:4px;">개수</th>
						<th style="padding:4px;">결제,주문일</th>
						<th style="padding:4px;">출고일</th>
						<th style="padding:4px;">발송처리일</th>
						<th style="padding:4px;">배송완료일</th>
						<th style="padding:4px;">배송상태</th>
						<th style="padding:4px;">사이트명</th>
						<th style="padding:4px;">구매자</th>
						<th style="padding:4px;">수하인</th>
						<th style="padding:4px;">핸드폰</th>
						<th style="padding:4px;">상품명</th>
						<th style="padding:4px;">주소</th>
						<th style="padding:4px;">priceKinds</th>
						<th style="padding:4px;">수량(소)</th>
						<th style="padding:4px;">수량(중)</th>
						<th style="padding:4px;">수량(대)</th>
					</tr>
				</thead>

				<tbody  style="font-size:11px;">
				<?php	
				if($dealRow->size() > 0){
					$NO = $dealRow->size();
					for($i=0; $i<$dealRow->size(); $i++){
						$dealRow->next();

						$kinds = explode("|", $dealRow->get('priceKinds'));
						$small = $kinds[2] == "" ? 0 : $kinds[2];
						$medium = $kinds[3] == "" ? 0 : $kinds[3];
						$large = $kinds[4] == "" ? 0 : $kinds[4];

						//해당거래 배송상태 뽑아내기
						$delNum = 0;
						if($dealRow->get('dstart') == 0)	$delNum = 4;
						elseif($dealRow->get('dstart') > 0){
							if($dealRow->get('dend') > 0)	$delNum = 11;
							else	$delNum = 1;
						}

						echo $M_HTML->input_Hidden('date_'.$dealRow->get('idx'), $dealRow->get('date'));
				?>
					<tr class="text-center_memberList" style="text-align:center; white-space:">
						<td style="padding:3px;"><?php echo $M_HTML->input_Checkbox("idx", $dealRow->get('idx'), "", ""); ?></td>
						<td style="padding:3px;"><?php echo $M_HTML->_Select2("dstatus_".$dealRow->get('idx'), $this->dstatus, $dealRow->get('status'), "form-control", "onChange='updateBydstatus();'"); ?></td>
						<td style="padding:3px;"><?php echo $M_HTML->input_Text2("deliveryNum_".$dealRow->get('idx'), "", "form-control");	?></td>
						<td style="padding:3px;"><?php echo date('Y-m-d H:i', strtotime($dealRow->get('time')));	?></td>
						<td style="padding:3px;"><?php echo date('Y-m-d', strtotime($dealRow->get('date')));	?></td>
						<td style="padding:3px;"><?php echo $M_HTML->input_Text2("dstart_".$dealRow->get('idx'), $dealRow->get('dstart'), "form-control", "font-size:12px; padding: 6px 8px;");	?></td>
						<td style="padding:3px;"><?php echo $M_HTML->input_Text2("dend_".$dealRow->get('idx'), $dealRow->get('dend'), "form-control", "font-size:12px; padding: 6px 8px;");	?></td>
						<td style="padding:3px;"><?php echo $this->searchDelivery[$delNum];?></td>
						<td style="padding:3px;"><?php echo $dealRow->get('companyName');	?></td>
						<td style="padding:3px;"><?php echo $dealRow->get('buyer');	?></td>
						<td style="padding:3px;"><?php echo $dealRow->get('recipient');	?></td>
						<td style="padding:3px;"><?php echo $dealRow->get('tel');	?></td>
						<td style="padding:3px; text-align:left;"><?php echo $dealRow->get('deal').", ".$dealRow->get('dealNum')."개";	?></td>
						<td style="text-align:left;"><?php echo $dealRow->get('addr');	?></td>
						<td style="text-align:left;"><?php echo $M_HTML->input_Text2('priceKinds_'.$dealRow->get('idx'), $dealRow->get('priceKinds'), 'form-control');	?></td>
						<td><?php echo $small;	?></td>
						<td><?php echo $medium;	?></td>
						<td><?php echo $large;	?></td>
					</tr>
			<?php
						$NO--;
					}
				} else {
			?>
					<tr style="text-align:center;">
						<td colspan="16">등록된 데이터가 없습니다.</td>
					</tr>
			<?php	}	?>
				</tbody>
			</table>
		</div><!--/* panel -->

		<!--/* C.M.W 판매 이외의 리스트 가져오기  -->
		<div class="panel panel-default" style="margin-top:100px;">
			<table class="table table-bordered table-hover" >
				<colgroup>
					<col width="5%">	<!--상태처리-->
					<col width="7%">	<!--결제,주문일-->
					<col width="5%">	<!--출고일-->
					<col width="5%">	<!--배송완료일-->
					<col width="4%">	<!--배송상태-->
					<col width="4%">	<!--사이트명-->
					<col width="5%">	<!--구매자-->
					<col width="5%">	<!--수하인-->
					<col width="8%">	<!--핸드폰-->
					<col width="12%">	<!--상품명-->
					<col width="17%">	<!--주소-->
					<col width="8%">	<!--소-->
					<col width="3%">	<!--소-->
					<col width="3%">	<!--중-->
					<col width="3%">	<!--대-->
				</colgroup>
				<thead style="font-size:10.5px; padding:3px;">
					<tr>
						<th style="padding:4px;">상태처리</th>
						<th style="padding:4px;">결제,주문일</th>
						<th style="padding:4px;">출고일</th>
						<th style="padding:4px;">배송완료일</th>
						<th style="padding:4px;">배송상태</th>
						<th style="padding:4px;">사이트명</th>
						<th style="padding:4px;">구매자</th>
						<th style="padding:4px;">수하인</th>
						<th style="padding:4px;">핸드폰</th>
						<th style="padding:4px;">상품명</th>
						<th style="padding:4px;">주소</th>
						<th style="padding:4px;">priceKinds</th>
						<th style="padding:4px;">수량(소)</th>
						<th style="padding:4px;">수량(중)</th>
						<th style="padding:4px;">수량(대)</th>
					</tr>
				</thead>
				<tbody class="otherthansales">
				
				</tbody>
			</table>
		</div><!--/* panel -->
		<!--판매 이외의 리스트 가져오는 부분 끝-->

	</div><!--/* contents-wrapper 1-->
	<!--/* 해당 월 합계 끝  --------------------------------------------------------------------------------------------------------------------
	</div><!--/* contents-wrapper -->
	<!--/* 상품단가표 리스트 끝  -->
</div><!-- container -->
<script>
	$(document).ready(function(){
		var html = "";
		var tmp = "";
		var ajax_url = "/page/ajax/M04/ajax.otherthansales.php";
		var ajax_data = {
			'year'	: $('#searchYear').val()
		};
		
		$.ajax({
			url : ajax_url,
			data : ajax_data,
			type : 'POST',
			dataType : 'JSON',
			contentType: 'application/x-www-form-urlencoded; charset=utf-8',
			success: function (response) {
				if(response){
					var len = Object.keys(response).length;
					if(len > 0){
						$.each(response, function(entryIndex, entry){
							tmp = '<tr style="text-align:center; white-space:">';
							tmp	+=	'<td style="padding:3px;">'+entry['status']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['time']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['date']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['dend']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['DS']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['companyName']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['buyer']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['recipient']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['tel']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['deal']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['addr']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['priceKinds']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['small']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['medium']+'</td>';
							tmp	+=	'<td style="padding:3px;">'+entry['large']+'</td>';
							tmp 	+= '	</tr>';
							html = tmp + html;
						});
					} else {
						html += '<tr><td colspan=16>해당되는 데이터가 없습니다.</td></tr>';
					}
					$('.otherthansales').html(html);
				}
			},
			failure: function(msg) {
			}
		});
	});
</script>