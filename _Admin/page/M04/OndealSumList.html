<script type="text/javascript" src="<?php	echo JS_DIR;	?>/adm_common.js"></script>

<script>
	$(document).ready(function(){
		$('#totalPrice').html(<?php echo $totalPrice;?>);
		$('.btn-example').click(function(){
			var $href = $(this).attr('href');
			layer_popup($href);
		});
		
		/* 파일업로드 되는 부분 시작 */
		var fileTarget = $('.filebox .upload-hidden');
		
		fileTarget.on('change', function(){ // 값이 변경되면
			if(window.FileReader){ // modern browser 
				var filename = $(this)[0].files[0].name;
			} else { // old IE 
				var filename = $(this).val().split('/').pop().split('\\').pop(); // 파일명만 추출 
			} 
			
			// 추출한 파일명 삽입 
			$(this).siblings('.upload-name').val(filename); 
		}); 
		/* 파일업로드 되는 부분 끝 */
	});

	function searchSubmit(){
		var frm = document.search_frm;
		frm.submit();
	}

	function searching(){
		window.location.href="/?M0401S&searchYear="+$('#searchYear').val()+"&searchMonth="+$('#searchMonth').val();
	}

	function deliverySearching(){
		window.location.href="/?M0401S&searchDay="+$('#searchDay').val()
	}

	function excelDownload(){
		window.location.href="page/M04/billing_Excel.php";
	}

	function layer_popup(el){
		var $el = $(el);        //레이어의 id를 $el 변수에 저장
		var isDim = $el.prev().hasClass('dimBg');   //dimmed 레이어를 감지하기 위한 boolean 변수

		isDim ? $('.dim-layer').fadeIn() : $el.fadeIn();

		var $elWidth = ~~($el.outerWidth()),
			$elHeight = ~~($el.outerHeight()),
			docWidth = $(document).width(),
			docHeight = $(document).height();

		// 화면의 중앙에 레이어를 띄운다.
		if ($elHeight < docHeight || $elWidth < docWidth) {
			$el.css({
			marginTop: $elHeight /3,
			marginLeft: $elWidth/3
			})
		} else {
			$el.css({top: 0, left: 0});
		}

		$el.find('a.btn-layerClose').click(function(){
			isDim ? $('.dim-layer').fadeOut() : $el.fadeOut(); // 닫기 버튼을 클릭하면 레이어가 닫힌다.
			return false;
		});

		$('.layer .dimBg').click(function(){
			$('.dim-layer').fadeOut();
			return false;
		});

	}

	function updateDealBydelivery(way, gubun, num){
		var ajax_url = "/page/ajax/M03/ajax.updateDealBydelivery.php";
		if(way == "all"){
			var ajax_data = {
				'way'		: way,
				'gubun'		: gubun,
				'start'		: "<?php echo $this->TermArr[11][0]; ?>",	//오늘 배송건중에 출력된걸 배송중으로 변경하기
				'end'		: "<?php echo $this->TermArr[11][1]; ?>"	//그래서 첫번째 인수로는 11: 오늘로 넣기
			};
		}

		$.ajax({
			url : ajax_url,
			data : ajax_data,
			type : 'POST',
			dataType : 'html',
			contentType: 'application/x-www-form-urlencoded; charset=utf-8',
			success: function (response) {
				if(response == 1) {
					alert('발송처리 되었습니다.');
				} else {
					alert('배송완료 되었습니다.');
				}
				location.reload();
			},
			failure: function(msg) {
			}
		});
	}
</script>
<div class="container">
	<div class="contents-wrapper">
		<h2 class="page-header">온라인 거래현황</h2>
	</div>

	<!--/* 해당 월 합계 끝  ---------------------------------------------------------------------------------------------------------------------->
	<div class="contents-wrapper" style='float:left; width:30%;'>
		<div class="panel panel-default">
			<div class="panel-heading text-center">
				<?php 
					echo $M_HTML->b_Form("search_frm", "", "get", 1);
					echo $M_HTML->input_Hidden($MENU_ID.$P_ACTION, "");
					echo $M_HTML->input_Hidden("PAGE", $PAGE);
				?>
				<div class="form-inline" style="display:flex;">
					<div style="text-align:left; flex:1;">
						<a href="?M0401R&searchMonth=<?php echo $searchMonth;?>" class="btn btn-sm btn-success" role="button">개별 등록</a>
					</div>					

					<div style="flex:1; padding-left:5px;">
						<a href="?M0401E" class="btn btn-sm btn-success" role="button">대량 등록</a>
					</div>

					<div style="text-align:center; flex:5;">
						<div class="form-group">
							<?php	echo $M_HTML->_Select2("searchYear", $this->searchYear, $searchYear, "form-control");	?>
							<?php	echo $M_HTML->_Select2("searchMonth", $this->searchMonth, $searchMonth, "form-control", "onchange='searching()'");	?>
						</div>
					</div>

					
				</div>
				<?php
					echo $M_HTML->e_Form();
				?>
			</div>
			<table class="table table-bordered table-hover">
				<colgroup>
					<col width="20%">
					<col width="13.5%">
					<col width="16%">
					<col width="13.5%">
					<col width="12%">
					<col width="25%">
				</colgroup>
				<thead>
					<tr>
						<th rowspan="2" style="padding:10px;">상호명</th>
						<th colspan='4' style="padding:10px;">택배수</th>
						<th rowspan="2" style="padding:10px;">합계</th>
					</tr>
					<tr>
						<th>소</th>
						<th>중</th>
						<th>대</th>
						<th>추가</th>
					</tr>
				</thead>

				<tbody>
			<?php
				if($dealRow->size() > 0){
					$num = $dealRow->size();

					$totalPrice = 0;
					$totalCnt = 0;
					$deliveryArr = array();
					for($i=0; $i<$dealRow->size(); $i++){
						$dealRow->next();

						$totalPrice_G += $dealRow->get('price');
						$totalCnt_G	+= $dealRow->get('cnt');
						
						$small = $deliveryByCompany[$dealRow->get('companyIdx')]['S'] == "" ? 0 : $deliveryByCompany[$dealRow->get('companyIdx')]['S'];
						$medium = $deliveryByCompany[$dealRow->get('companyIdx')]['M'] == "" ? 0 : $deliveryByCompany[$dealRow->get('companyIdx')]['M'];
						$large = $deliveryByCompany[$dealRow->get('companyIdx')]['L'] == "" ? 0 : $deliveryByCompany[$dealRow->get('companyIdx')]['L'];

						$deliveryArr['S'] +=  $small;
						$deliveryArr['M'] +=  $medium;
						$deliveryArr['L'] +=  $large;
						$deliveryArr['add'] +=  $deliveryByCompany[$dealRow->get('companyIdx')]['add'];

			?>
					<tr data-href="/?M0401L&m_id=<?php echo $dealRow->get("companyIdx");?>&year=<?php echo $searchYear;?>&month=<?php echo $searchMonth;?>" class="text-center_memberList" style="text-align:center;" >
						<td style="text-align:left; padding-left:10px;"><?php echo $dealRow->get('companyName');	?></td>		
						<td style="text-align:right; padding-right:10px;"><?php echo $small;	?>개</td>	
						<td style="text-align:right; padding-right:10px;"><?php echo $medium;	?>개</td>	
						<td style="text-align:right; padding-right:10px;"><?php echo $large;	?>개</td>	
						<td style="text-align:right; padding-right:10px;"><?php echo $deliveryByCompany[$dealRow->get('companyIdx')]['add'];	?>개</td>	
						<td style="padding:3px 10px 3px 0; text-align:right;"><?php echo number_format($dealRow->get('price'));	?>원</td>
					</tr>
			<?php		
						$num--;
					}
				} else {
			?>
					<tr style="text-align:center;">
						<td colspan="5"><?php echo $searchYear."년 ".$searchMonth."월에 대한 판매가 없습니다."; ?></td>
					</tr>
			<?php	
				}
			?>
					<tr>
						<th rowspan='3' style="padding:8px; background-color:black; color:white; font-size:15px;">총 합계</th>
						<!--th style="padding:8px; background-color:black; color:white; font-size:13px;"><?php echo totalCnt_G;?>개</th-->
						<th style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:13px;"><?php echo number_format($deliveryArr['S']);?>개</th>
						<th style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:13px;"><?php echo number_format($deliveryArr['M']);?>개</th>
						<th style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:13px;"><?php echo number_format($deliveryArr['L']);?>개</th>
						<th style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:13px;"><?php echo number_format($deliveryArr['add']);?>개</th>
						<th rowspan='3' id="totalPrice" style="background-color:black; color:white; padding:3px 10px 3px 0; text-align:right; font-size:14px;"><?php echo number_format($totalPrice_G);?>원</th>
					</tr>
					<tr>
					<?php
						$S_price = $deliveryArr['S']*2500;
						$M_price = $deliveryArr['M']*3000;
						$L_price = $deliveryArr['L']*3500;
						$add_price = $deliveryArr['add']*3000;
						
						$totalCnt_D = $deliveryArr['S'] + $deliveryArr['M'] +	$deliveryArr['L'];
						$totalPrice_D = $S_price + $M_price + $L_price;
					?>
						<th style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:10px;"><?php echo number_format($S_price);?>원</th>
						<th style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:10px;"><?php echo number_format($M_price);?>원</th>
						<th style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:10px;"><?php echo number_format($L_price);?>원</th>
						<th style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:10px;"><?php echo number_format($add_price);?>원</th>
					</tr>
					<tr>
						<td style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:14px;"><?php echo number_format($totalCnt_D);?>개</td>
						<td colspan='2' style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:14px;"><?php echo number_format($totalPrice_D);?>원</td>
						<td style="background-color:black; color:white; padding:3px 4px 3px 0; text-align:right; font-size:10px;"><?php echo number_format($add_price);?>원</td>
					</tr>
				</tbody>
			</table>
		</div><!--/* panel -->

		<!--/* C.M.W 금일 출고리스트  -->
		<div class="panel panel-default">
			<table class="table table-bordered table-hover" >
				<colgroup>
					<col width="*">
					<col width="*">
				</colgroup>
				<thead style="font-size:14px; padding:3px;">
					<tr>
						<th colspan='2' style="padding:5px 0 5px 0; font-size:18px; font-weight:500; background:#2F4050; color:white">금일 출고리스트
						<?php 
							//선택한 날짜로 출고리스트 보여주기
							//오늘 기준 ±3일 보여주기
							$yesterday3 = date('d', strtotime('3 day ago', time()));
							$yesterday2 = date('d', strtotime('2 day ago', time()));
							$yesterday1 = date('d', strtotime('1 day ago', time()));
							$today = date('d', time());
							$tomorrow1 = date('d', strtotime('-1 day ago', time()));
							$tomorrow2 = date('d', strtotime('-2 day ago', time()));
							$tomorrow3 = date('d', strtotime('-3 day ago', time()));
							$arrDay = array($yesterday3 => $yesterday3."일", $yesterday2 => $yesterday2."일", $yesterday1 => $yesterday1."일", $today => $today."일", $tomorrow1 => $tomorrow1."일", $tomorrow2 => $tomorrow2."일", $tomorrow3 => $tomorrow3."일");
							echo $M_HTML->_Select2("searchDay", $arrDay, $searchDay, "form-control", "onChange='javascript:deliverySearching();'");
						?>
						</th>
					</tr>
					<tr>
						<th style="padding:4px;">상품명</th>
						<th style="padding:4px;">수량</th>
					</tr>
				</thead>
				<tbody  style="font-size:13px;">
				<?php
					$totalCnt = 0;
					foreach($deliveryToday as $key => $value){
						$totalCnt += $value['cnt'];
				?>						
					<tr>
						<td style='padding:3px 0 3px 10px;'><?php echo $key;	?></td>
						<td style='text-align:right; padding:3px 5px 3px 0;'><?php echo $value['cnt']	?>개</td>
					</tr>
				<?php
					}
				?>
					<tr style=' padding:2px;'>
						<td style="background-color:black; color:white; padding:3px 0 3px 10px; font-size:14px;">총 택배수</td>
						<td style="background-color:black; color:white; padding:3px 5px 3px 0; text-align:right; font-size:14px;">총 <?php echo $totalCnt;?>개</td>
					</tr>
				</tbody>
			</table>
		</div><!--/* panel -->
		<!--/* C.M.W 공지사항 끝  -->

		<!--div class="pull-left">
			<a href="?M0401R&searchMonth=<?php echo $searchMonth;?>" class="btn btn-sm btn-success" role="button">송장 등록</a>
		</div-->
	</div><!--/* contents-wrapper 1-->
	<!--/* 해당 월 합계 끝  ---------------------------------------------------------------------------------------------------------------------->

	<!--/* 해당 월 일별 합계  --------------------------------------------------------------------------------------------------------------------->
	<div class="contents-wrapper" style='float:left; width:70%;'>
		<div class="panel panel-default">
			

			<div class="panel-heading text-center" style="padding:10px 10px;">
				
				<div class="form-inline" style="display:flex;">	<!---->
					<div cstyle="flex:1;">
						<button class="btn btn-sm btn-warning" onclick="javascript:updateDealBydelivery('all', 'dstart'); return false;">전체 발송</button>
					</div>
					<div style="flex:1;">
						<a href="?M0401I" class="btn btn-sm btn-danger" role="button">배송비 설정</a>
					</div>
					<div style="flex:1;">
						<a href="javascript:excelDownload();" class="btn btn-sm btn-primary" role="button">Excel Download</a>
					</div>
					 <div style="font-size:20px; font-weight:bold; flex:6; margin-right:280px;">	<!--padding:5px 150px 0 0;-->
						<?php echo $searchMonth;?>월 <!--span style="margin-left:30px; font-size:14px; font-weight:bold;">총 합계: <?php echo number_format($totalPrice);?>원</span-->
					</div>
				</div>
				<?php
					echo $M_HTML->e_Form();
				?>
			</div>
			<table class="table table-bordered table-hover">
				<colgroup>
					<col width="14%">
					<col width="14%">
					<col width="14%">
					<col width="14%">
					<col width="14%">
					<col width="14%">
					<col width="14%">
				</colgroup>
				<thead>
					<tr>
						<th style="background-color:red; color:white; padding:2px;">일</th>
						<th style="background-color:#BDBDBD; padding:2px;">월</th>
						<th style="background-color:#BDBDBD; padding:2px;">화</th>
						<th style="background-color:#BDBDBD; padding:2px;">수</th>
						<th style="background-color:#BDBDBD; padding:2px;">목</th>
						<th style="background-color:#BDBDBD; padding:2px;">금</th>
						<th style="background-color:red; color:white; padding:2px;">토</th>
					</tr>
					
				<?php
					//$tr_arr			= array(0, 6, 7, 13, 14, 20, 21, 27, 28, 34, 35, 41);
					$day = 1;
					for($i=0; $i<42; $i++){
						if(strlen($searchMonth) < 2) $date = $searchYear."0".$searchMonth."01";
						else $date = $searchYear.$searchMonth."01";

						if($i%7 == 0) echo "<tr>";

						while(date('w', strtotime($date)) > $i){
							echo "<td></td>";
							$i++;
						}

						if($day <= $this->monthByDay[$searchMonth]){
							$selectDate = strlen($day) < 2 ? substr($date, 0, 6)."0".$day : substr($date, 0, 6).$day;
				?>
						<td data-href="?M0403&searchDelivery=0&searchTerm=11&date=<?php echo $selectDate;?>" style='padding:3px;'><?php echo $day; ?>.</br>
				<?php
							$totalPrice = 0;
							for($j=0; $j<sizeof($dayPriceArr[$day]); $j++){
						
								$totalPrice += (int)$dayPriceArr[$day][$j]['price'];

								echo "<div class='calender_left' style='font-size:10.5px;'>".$dayPriceArr[$day][$j]['name']."</div><div class='calender_right'>".number_format($dayPriceArr[$day][$j]['price'])."원</div>";
								echo "</br>";
							}
				?>
						<div class='calender_total_left'>합계</div><div class='calender_total_right'><?php echo number_format($totalPrice); ?>원</div>
					</td>
				<?php
						} else {
							echo "<td></td>";
						}

						$day++;
						if($i%7 == 6) echo "</tr>"; 
					}
				?>
				</thead>
				<tbody>
			
				</tbody>
			</table>
		</div><!--/* panel -->
	</div><!-- contents-wrapper2 -->
	<!--/* 해당 월 일별 합계  --------------------------------------------------------------------------------------------------------------------->

</div><!-- container -->

<div style="clear:both;"></div>