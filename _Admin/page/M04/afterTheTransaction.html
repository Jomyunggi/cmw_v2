<script type="text/javascript" src="<?php	echo JS_DIR;	?>/adm_common.js"></script>
<script>
	$(document).ready(function(){
		$("#all").click(function(){
			if($("#all").prop("checked")){
				$("input[name=dealIdx]").prop("checked",true);
			} else {
				$("input[name=dealIdx]").prop("checked",false);
			}
		});
	});

	function searchSubmit(){
		var frm = document.search_frm;
		frm.submit();
	}

	function discountChange(val, idx){
		$("#discount"+idx).val(val);
	}

	function comma(num){
		var len, point, str; 
		   
		num = num + ""; 
		point = num.length % 3 ;
		len = num.length; 
	   
		str = num.substring(0, point); 
		while (point < len) { 
			if (str != "") str += ","; 
			str += num.substring(point, point + 3); 
			point += 3; 
		} 
		 
		return str;
	 
	}

	function receive(gubun) {
		var checkArr = new Array();
		var priceData = new Array();
		var discountData = new Array();
		
		if(gubun == 'all'){
			//체크박스 체크한 데이터 가져와서 배열에 담기
			var $checkboxes = $(".text-center_receiveList").find(':checkbox:checked');
			$checkboxes.each(function(index){
				checkArr.push($(this).val());
			});

			//금액의 데이터를 가져와 배열에 담기
			var price = 0;
			for(var i=0; i<checkArr.length; i++){
				price = $('#price'+checkArr[i]).val();
				priceData[i] = price;
			}
			
			//할인금액의 데이터를 가져와 배열에 담기
			var discount = 0;
			for(var i=0; i<checkArr.length; i++){
				discount = $('#discount'+checkArr[i]).val();
				discountData[i] = discount;
			}
		} else {
			checkArr.push(gubun);
			priceData.push($('#price'+gubun).val());
			discountData.push($('#discount'+gubun).val());
		}

		if (checkArr.length < 1){
			alert("정산 할 거래를 하나 이상 선택하여 주세요");
			return;
		} else {
			var conf = confirm("선택한 거래를 정산하시겠습니까?");
			var ajax_url = "/page/ajax/M04/ajax.deal_receive.php";
			var ajax_data = {
				'year'			: '<?=$year?>',
				'idx'			: checkArr,
				'price'			: priceData,
				'discount'		: discountData,
				'companyIdx'	: '<?=$searchCompany?>'
			}
			if(conf){
				$.ajax({
					url : ajax_url,
					data : ajax_data,
					type : 'POST',
					dataType : 'text',
					contentType: 'application/x-www-form-urlencoded; charset=utf-8',
					success : function(response){
						if(response == "success"){
							alert("작업에 대해서 정산되었습니다.");
						} else {
							alert("다시 확인부탁드립니다.");
						}
						location.href="/?M0402L&searchCompany=<?php echo $searchCompany;?>&year=<?php echo $year;?>&PAGE=<?php echo $PAGE;?>";
					}
				});
			}
		}
	}
</script> 
<div class="container">
	<div class="contents-wrapper">
		<div class="page-header" style="font-size:22px; font-weight:bold; margin:20px 0 10px;">
			정산현황&nbsp;&nbsp;&nbsp;<span style="font-size:12px;">쿠팡(12/30(월)완료), 티몬,위메프(12/30(월)완료), 11번가(12/30(월)완료),옥션(12/30(월)완료), 지마켓(12/30(월)완료), 네스팜(12/30(월)완료)</span>
		</div>
		<div style="float:left; font-size:12px; margin:5px 0 10px;">■사이트별 판매수수료<br/>
			<table class="table table-bordered table-hover" style="margin-top:5px;">
				<tbody><tr align="center">
		<?php
			foreach($commissionArr as $key => $value){
		?>
					<td width="110px;" style="padding:5px; background-color:#f5f5f5;"><?php echo $companyArr[$key]; ?></td>
					<td width="50px;" style="padding:5px;"><?php echo $value."%";	?></td>
		<?php
			}
		?>
				</tr></tbody>
			</table>
			■ <?php echo $companyArr[$searchCompany];?> 정산방식<br/>
			<?php 
				echo $this->CompanyBycontents[$companyArr[$searchCompany]];	
				if($companyArr[$searchCompany] == '위메프'){
					echo "<br/><img src='/images/wemakeprice.jpg' height='170px'>";
				}
			?>
		</div>
	</div>

	<!--/* 회원리스트  -->
	<div class="contents-wrapper">
		<div class="panel panel-default">
			<div class="panel-heading text-center">
				<?php 
					echo $M_HTML->b_Form("search_frm", "", "get", 0);
					echo $M_HTML->input_Hidden($MENU_ID.$P_ACTION, "");
					//echo $M_HTML->input_Hidden("PAGE", $PAGE);
				?>

				<div class="form-inline" style="display:flex;">
					<div style="text-align:left; flex:1;">
					<?php	if($transactionRow->size() > 0){	?>
						<a href="javascript:receive('all');" id='layer' class="btn btn-sm btn-success"><i class="fa fa-won fa-fw"></i> 선택 정산</a>
					<?php	}	?>
					</div>
					
					<div style="text-align:left; flex:2;">
						<div class="form-group" style="margin-right:5px;">
							<?php	echo $M_HTML->_Select2("year", $this->searchYear, $year, "form-control");	?>
							<?php	echo $M_HTML->_Select2("searchCompany", $companyArr, $searchCompany, "form-control");	?>
						</div>

						<div class="form-group input-group">
							<span class="input-group-btn">
								<button class="btn btn-default" type="button" onclick="searchSubmit();"><i class="fa fa-search"></i> 검색</button>
							</span>
						</div>	
					</div>
				</div>
				<?php
					echo $M_HTML->e_Form();
				?>
			</div>

			<table class="table table-bordered table-hover" >
				<colgroup>
					<col width="4%">
					<col width="*%">
					<col width="*%">
					<col width="8%">
					<col width="8%">
					<col width="*%">
					<col width="*%">
					<col width="*%">
					<col width="*%">
					<col width="8%">
					<col width="6%">
					<col width="8%">
					<col width="*%">
					<col width="7%">
				</colgroup>
				<thead style="font-size:10.5px; padding:3px;">
					<tr>
						<th style="padding:4px;"><input type="checkbox" id="all"></th>
						<th style="padding:4px; vertical-align:middle;">출고일</th>
						<th style="padding:4px; vertical-align:middle;">결제일</th>
						<th style="padding:4px; vertical-align:middle;">구매자</th>
						<th style="padding:4px; vertical-align:middle;">수취인</th>
						<th style="padding:4px; vertical-align:middle;">주소</th>
						<th style="padding:4px; vertical-align:middle;">상품명</th>
						<th style="padding:4px; vertical-align:middle;">수량</th>
						<th style="padding:4px; vertical-align:middle;">택배비</th>
						<th style="padding:4px; vertical-align:middle;">금액</th>		
						<th style="padding:4px; vertical-align:middle;">판매수수료</th>	
						<th style="padding:4px;">예상정산금</th>
						<th style="padding:4px; vertical-align:middle;">할인금액</th>
						<th style="padding:4px; vertical-align:middle;">정산하기</th>
					</tr>
					<tr>
						<th style="padding:8px; vertical-align:middle; font-size:14px;" colspan="8">정산금 합계 (판매수수료 + 정산금액 = 판매금액)</th>
						<th id="total_receive" style="padding:8px; vertical-align:middle; font-size:14px;" colspan="5"></th>
					</tr>
				</thead>

				<tbody>
				<?php

				$total_receive = 0;
				$total_commission = 0;
				$total_price = 0;
				if($transactionRow->size() > 0){
					for($i=0; $i<$transactionRow->size(); $i++){
						$transactionRow->next();

						$releaseDay = date('Y.m.d', strtotime($transactionRow->get('date')));
						if((int)$transactionRow->get('time') == 0){
							$paymentDay = $releaseDay;
						} else {
							$paymentDay = date('Y.m.d H:i', strtotime($transactionRow->get('time')));
						}
						
						//0=>금액, 1=>택배비, 2=>택배소, 3=>택배중, 4=>택배대
						$goods = explode('|', $transactionRow->get('priceKinds'));
						if($goods[0] == "") $price = 0;
						else $price = $goods[0];

						if($goods[1] != '0' && $goods[1] != '' ){
							$price += $goods[1];
						}

						$dealName = str_replace("[공장직영 도매]", "", $transactionRow->get('deal'));

						//정산금액 측정하기		ceil 올림, round 반올림, floor 내림
						$receive = ceil($goods[0] * (100 - $commissionArr[$transactionRow->get('companyIdx')])/100);
						$commission = floor($price * $commissionArr[$transactionRow->get('companyIdx')]/100);
						if($goods[1] != '0' && $goods[1] != '' ){
							$deliveryR = ceil($goods[1] * ($commissionArr[$transactionRow->get('companyIdx')])/100);
							$commission -= $deliveryR;
						}
						$total_receive += (int)$receive;
						$total_commission += (int)$commission;
						$total_price += (int)$goods[0];

				?>
					<tr class="text-center_receiveList" align="center">
						<td><input type="checkbox" value="<?php echo $transactionRow->get("idx");?>" id="idx2" name="dealIdx" /></td>
						<td><?php echo $releaseDay;	?></td>
						<td><?php echo $paymentDay;	?></td>
						<td><?php echo $transactionRow->get('buyer');	?></td>
						<td><?php echo $transactionRow->get('recipient');	?></td>
						<td align="left" style="padding-left:10px;">
							<?php echo substr($transactionRow->get('addr'), 0, 40);	?></td>
						<td align="left" style="padding-left:10px;">
							<?php echo substr($dealName, 0, 55);	?></td>
						<td align="right" style="padding-right:10px;">
							<?php echo $transactionRow->get('dealNum');	?>개</td>
						<td align="right"style="padding-right:10px;">
							<?php echo number_format((int)$goods[1]);	?>원</td>
						<td align="right"style="padding-right:10px;">
						<?php
							echo $M_HTML->input_Hidden('price'.$transactionRow->get("idx"), $price);
							echo $M_HTML->input_Text2('price', number_format($price), "table-bordered", 'vertical-align:middle; width:80%; text-align:right;', 'readonly'); ?> 원</td>
						<td align="right"style="padding-right:10px;">
						<?php echo number_format((int)$commission);	?> 원</td>
						<td align="right"style="padding-right:10px;">
						<?php echo number_format((int)$price-$commission);	?> 원</td>
						<td align="right"style="padding-right:10px;">
						<?php 
							echo $M_HTML->input_Hidden('discount'.$transactionRow->get("idx"), '');
							echo $M_HTML->input_Text2('discount', 0, "table-bordered", 'vertical-align:middle; width:80%; text-align:right;', 'onchange="discountChange(this.value, '.$transactionRow->get("idx").')"'); ?> 원</td>
						<td><a href="javascript:receive('<?php echo $transactionRow->get("idx");?>');" id='layer' class="btn btn-sm btn-success"><i class="fa fa-won fa-fw"></i> 정산</a></td>
					</tr>
				<?php
						$NO--;
					}
				}
				$total_txt = number_format($total_commission)." + ".number_format($total_receive)." = ".number_format($total_price)." 원";
				echo $M_HTML->input_Hidden('total_receive', $total_txt);
				?>
		
				</tbody>
			</table>
		</div><!--/* panel -->

		<div id="paging" style="margin-top:0px;">
		<?php	
			$page = $PAGE;
			$totalPage = $total_page;
			$pageURL = '';
			$URLParam = $URLParam;
			echo $M_FUNC->pagingJumper3($page, $totalPage, $pageURL, $URLParam);
			echo $M_HTML->input_Hidden("page", '');
		?>
		</div>
		
	</div><!--/* contents-wrapper -->
	<!--/* 상품단가표 리스트 끝  -->

</div><!-- container -->
<script>
	$(document).ready(function(){
		var total_receive = $('input[name="total_receive"]').val();
		$("#total_receive").html(total_receive);
	});
</script>