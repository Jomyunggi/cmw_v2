<script>
$(document).ready(function(){	
	$("#cIdx").click(function(){
		if(this.value == 0){
			if($("#cIdx").prop("checked")){
				$("input[id=cIdx]").prop("checked",true);
			} else {
				$("input[id=cIdx]").prop("checked",false);
			}
		}
	});

	$("#categorys").click(function(){
		if(this.value == 0){
			if($("#categorys").prop("checked")){
				$("input[id=categorys]").prop("checked",true);
			} else {
				$("input[id=categorys]").prop("checked",false);
			}
		}
	});
});

function delHangle(evt){	//한글을 지우는 부분, keyup부분에 넣어준다.
	var objTarget = evt.srcElement || evt.target;
	var _value = event.srcElement.value;
	if(/[ㄱ-하-ㅡ가-핳]/g.test(_value)){
		// objTarget.value = objTarget.value.replace(/[ㄱ-하-ㅡ가-핳]/g, ''
		objTarget.value = null;
		//return fales;
	} else{
		if(/[a-zA-Z]/.test(_value)){
			//objTarget.value = objTarget.value.replace(/[a-zA-Z]/g, ''
			objTarget.value = null;
		}
	}
}

function isNumberkey(evt){	// 숫자를 제외한 값을 입력하지 못하게 한다.
	var charCode = (evt.which) ? evt.which : event.keyCode;
	var _value = event.srcElement.value;
	
	if(event.keyCode < 48 || event.keyCode > 57){
		if(event.keyCode != 46){ //숫자와 .만 입력가능하도록함
			return fales;
		}
	}

	//소수점(.)이 두번이상 나오지 못하게
	var _pattern0 = /^\*[.]\d*$/;	//현재 value값에 소수점(.)이 있으면 . 입력
	if(_pattern0.test(_value)){
		if(charCode == 46){
			return fales;
		}
	}

	//두자리 이하의 숫자만 입력가능
	var _pattern1 = /^\d{2}$/;	//현재 value값이 2자리 숫자이면 .만 입력가능
	//{숫자}의 값을 변경하면 자리수를 조정할 수 있다.
	if(_pattern1.test(_value)){
		if(charCode != 46){
			return fales;
		}
	}

	//소수점 둘째자리까지만 입력가능
	var _pattern2 = /^\d*[.]\d{2}$/;	//현재 value값이 소수점 둘째자리 숫자이면   /^\d*[.]\d{2}$/	/^\d*.?\d{0,2}$/
	//{숫자}의 값을 변경하면 자리수를 조정할 수 있다.
	if(_pattern2.test(_value)){
		alert('소수점 둘째자리까지만 입력가능합니다.');
		return false;
	}
	return true;
}

function searchSubmit(){
	var frm = document.search_frm;

	if(valueCheck("searchTxt", "마진율") == false)	return false;

	frm.submit();
}

function valueCheck(key, msg) {
	if($("#"+key).val() == "" || $("#"+key).val() == 0) {
		alert(msg+"을 입력해 주세요");
		$("#"+key).focus();
		return false;
	}
	return true;
}
</script>

<div class="container">
	<div class="contents-wrapper">
		<div class="page-header" style="font-size:22px; font-weight:bold; margin:20px 0 10px;">마진별 판매금액</div>
	</div>

	<!--/* 회원리스트  -->
	<div class="contents-wrapper" style="padding-top:6px;">
		<div class="panel panel-default">
			<div class="panel-heading">
				<?php 
					echo $M_HTML->b_Form("search_frm", "", "get", 0);
					echo $M_HTML->input_Hidden($MENU_ID, "");
				?>
				
				<div class="form-inline">
					<div style="text-align:left; flex:1;">
						
						<a href="#layer1" class="btn btn-sm btn-default"><i class="fa fa-users fa-lg"></i> 사이트지정</a>
						<?php
							echo $M_HTML->input_Checkbox("cIdx", $onlineArr, '', $cIdx);
						?><br/>

						<a href="#layer2"class="btn btn-sm btn-default"><i class="fa fa-tags fa-lg"></i> &nbsp;상품 지정&nbsp;</a>
						<?php
							echo $M_HTML->input_Checkbox("categorys", $this->Category, '', $categorys, '', 80);
						?><br/>
					</div>

					<div style="text-align:right; flex:2;">
						<div class="form-group">마진율 : &nbsp;</div>
						<div class="form-group input-group">
							<input type="text" name="searchTxt" id="searchTxt" class="form-control" onkeypress='return isNumberkey(event)' onkeyup='return delHangle(event)' value="<?php echo $searchTxt;?>">
							<span class="input-group-btn">
								<button class="btn btn-default" type="button" onclick="searchSubmit();"><i class="fa fa-search"></i> 검색</button>
							</span>
						</div>
					</div>

				</div>
				
				<?php
					echo $M_HTML->e_Form();
				?>
			</div>
			<table class="table table-bordered table-hover">
				<colgroup>
					<col width="15%">
					<col width="8%">
					<col width="12%">
					<col width="4%">
					<col width="8%">
					<col width="8%">
					<col width="8%">
					<col width="8%">
					<col width="10%">
					<col width="12%">
					<col width="8%">
					
				</colgroup>
				<thead>
					<tr>
						<th style="padding:10px;">사이트명 | 판·수 | 확·수 </th>
						<th style="padding:10px;">카테고리</th>
						<th style="padding:10px;">상품명</th>
						<th style="padding:10px;">수량</th>						
						<th style="padding:10px;">원가</th>
						<th style="padding:10px;">판매금액</th>
						<th style="padding:10px;">정산금액</th>
						<th style="padding:10px;">1차 공장수익</th>
						<th style="padding:10px;">희망 순수익</th>
						<th style="padding:10px;">최종 순수익<br/>(-부.종소세)</th>
						<th style="padding:10px;">마진율</th>
					</tr>
				</thead>
				<tbody style="font-size:11.5px;">
				<?php
					if($row->size() > 0){
						$tmpValue = '';
						$tmp = 0;
						foreach($cIdx as $key => $value){
							for($i=0; $i<$row->size(); $i++){
								$row->next();
								
								if($tmpValue != $value){
									$tmpValue = $value;
									$tmp = 1;
								} else $tmp = false;

								//사이트명
								$siteName = $onlineArr[$value]." | ".$feesS_Arr[$onlineArr[$value]]." | ".$feesArr[$onlineArr[$value]];

								//원가 + 알파값
								$firstCost = $row->get('cost') + 300;
								//최종판매액 구하기		((10-종소세)*(원가+택배비)/(-11*최종마진율+(10-종소세)*(1-사이트판매수수료)))
								$cost = $firstCost + $this->deliveryP[$row->get('size')];		//기존원가를 높여준다(정확한 원가가 아니므로 손해를 생각해서 올려줌)
								$finalSales = round(((10-$this->smallTax)*$cost/(-11*($searchTxt/100)+(10-$this->smallTax)*(1-$feesArr[$onlineArr[$value]]/100))), -1);// + ($row->get('price') * $this->adPrice);
								//판매사이트 수수료금액 alSales * $feesArr[$onlineArr[$value]]/100;
								$siteFees = $finalSales * $feesS_Arr[$onlineArr[$value]]/100;
								//부가세
								$vat = ($finalSales - $cost - $siteFees)/11;
								//종소세
								$smallTax = $vat * $this->smallTax;
								//정산금액
								$settlementAmount = $finalSales - $siteFees;
								//1차순수익
								$firstRevenue = $row->get('price') - $firstCost;
								//1차 공장 20% 마진율 순수익
								$revenue_hope = $row->get('price') * 0.2 + ($finalSales * $this->adPrice);
								//최종 순수익
								$revenue = $finalSales - $cost - $siteFees;
								//마진율
								$marginRate = $revenue/$finalSales;

								if($tmp){
				?>
					<tr style="height:8px; background-color:black;"><td colspan='11'></td></tr>
				<?php			}	?>
					<tr>
						<td align="center" style="padding:5px;"><?php echo $siteName;	?></td>
						<td align="center" style="padding:5px;"><?php echo $this->Category[$row->get('category')];	?></td>
						<td align="left" style="padding:5px 5px 5px 10px;"><?php echo $row->get('gName')." ".$row->get('rollType');	?>롤</td>
						<td align="right" style="padding:5px;"><?php echo $row->get('count');	?></td>
						<td align="right" style="padding:5px;"><?php echo number_format($row->get('cost'));	?></td>
						<td align="right" style="padding:5px; background-color:black; color:white; font-weight:bold;"><?php echo number_format($finalSales);	?></td>
						<td align="right" style="padding:5px;"><?php echo number_format($settlementAmount);	?></td>
						<td align="right" style="padding:5px;"><?php echo number_format($firstRevenue);	?></td>
						<td align="right" style="padding:5px;"><?php echo number_format($revenue_hope);	?></td>
						<td align="right" style="padding:5px;"><?php echo number_format($revenue)." - ".round(($vat+$smallTax), 0)." = ".number_format($revenue-$vat-$smallTax);	?></td>
						<td align="right" style="padding:5px;"><?php echo number_format($marginRate*100, 2);	?>%</td>
					</tr>
				<?php
							}
							//foreach문 안에서 돌기땜에 row가 초기화되어야되는데 못해서 다시 쿼리 날림.
							$row = $this->getFinalSales($addWhere);
						}
					} else {
				?>
					<tr style="text-align:center;">
						<td colspan='10'>해당 데이터가 없습니다</td>
					</tr>
				<?php
					}
				?>
				</tbody>
			</table>
		</div><!--/* panel -->


	</div><!--/* contents-wrapper -->
	<!--/* 회원리스트 끝  -->


</div><!-- container -->